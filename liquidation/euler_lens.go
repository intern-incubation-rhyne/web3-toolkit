package liquidation

import (
	"bytes"
	"context"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"io"
	"math/big"
	"net/http"
	"strings"
	"toolkit/query"
	"toolkit/trace"
	"toolkit/utils"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/ethclient"
)

const (
	eulerLensAbi              = `[{"type":"function","name":"getRevenue","inputs":[{"name":"debt","type":"address","internalType":"address"},{"name":"debtAmount","type":"uint256","internalType":"uint256"},{"name":"collateral","type":"address","internalType":"address"},{"name":"collateralAmount","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"int256","internalType":"int256"},{"name":"","type":"uint256","internalType":"uint256"},{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"}]`
	eulerLensDeployedBytecode = "0x608060405234801561000f575f5ffd5b5060043610610055575f3560e01c8063125c53d1146100595780632287f9f21461008b57806362bc05dc146100bb5780637a6bfd9d146100ec578063fbbffe6b14610120575b5f5ffd5b610073600480360381019061006e9190610984565b610150565b60405161008293929190610a0f565b60405180910390f35b6100a560048036038101906100a09190610a44565b6101a1565b6040516100b29190610a82565b60405180910390f35b6100d560048036038101906100d09190610a9b565b6102c8565b6040516100e3929190610b0e565b60405180910390f35b61010660048036038101906101019190610a44565b6104c7565b604051610117959493929190610b50565b60405180910390f35b61013a60048036038101906101359190610bcb565b610837565b6040516101479190610a82565b60405180910390f35b5f5f5f5f5f5f5f5f6101628c8c6104c7565b945094509450945094505f61017b8b8b87878787610837565b905085816101899190610c81565b86829850985098505050505050509450945094915050565b5f5f8373ffffffffffffffffffffffffffffffffffffffff166338d52e0f6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156101ec573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102109190610cd5565b90505f6e0d6ffc74a8feb35af5827bf57f678673ffffffffffffffffffffffffffffffffffffffff16637de4fd108360016040518363ffffffff1660e01b815260040161025e929190610d1a565b602060405180830381865afa158015610279573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061029d9190610d55565b9050670de0b6b3a764000081856102b49190610d80565b6102be9190610dee565b9250505092915050565b5f5f5f8673ffffffffffffffffffffffffffffffffffffffff16637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa158015610314573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103389190610cd5565b90505f8773ffffffffffffffffffffffffffffffffffffffff16633e8333646040518163ffffffff1660e01b8152600401602060405180830381865afa158015610384573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103a89190610cd5565b90508173ffffffffffffffffffffffffffffffffffffffff16638418e6f3878a846040518463ffffffff1660e01b81526004016103e793929190610e1e565b608060405180830381865afa158015610402573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104269190610e53565b909192509091509050809450508173ffffffffffffffffffffffffffffffffffffffff16638418e6f38689846040518463ffffffff1660e01b815260040161047093929190610e1e565b608060405180830381865afa15801561048b573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104af9190610e53565b90919250909150905080935050505094509492505050565b5f5f5f5f5f5f8773ffffffffffffffffffffffffffffffffffffffff16637dc0d1d06040518163ffffffff1660e01b8152600401602060405180830381865afa158015610516573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053a9190610cd5565b90505f8873ffffffffffffffffffffffffffffffffffffffff16633e8333646040518163ffffffff1660e01b8152600401602060405180830381865afa158015610586573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105aa9190610cd5565b90505f8273ffffffffffffffffffffffffffffffffffffffff1663ae68676c8a8c73ffffffffffffffffffffffffffffffffffffffff166338d52e0f6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610613573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106379190610cd5565b856040518463ffffffff1660e01b815260040161065693929190610e1e565b602060405180830381865afa158015610671573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106959190610d55565b90505f82905061034873ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036106e85773a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4890505b5f8173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610732573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107569190610ecb565b90505f6e0d6ffc74a8feb35af5827bf57f678673ffffffffffffffffffffffffffffffffffffffff16637de4fd108460016040518363ffffffff1660e01b81526004016107a4929190610d1a565b602060405180830381865afa1580156107bf573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107e39190610d55565b90505f8260246107f39190610ef6565b600a6107ff9190611059565b828661080b9190610d80565b6108159190610dee565b905080878785859b509b509b509b509b50505050505050509295509295909350565b5f5f8573ffffffffffffffffffffffffffffffffffffffff1663ae68676c888a886040518463ffffffff1660e01b815260040161087693929190610e1e565b602060405180830381865afa158015610891573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108b59190610d55565b90508360246108c49190610ef6565b600a6108d09190611059565b83826108dc9190610d80565b6108e69190610dee565b9150509695505050505050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610920826108f7565b9050919050565b61093081610916565b811461093a575f5ffd5b50565b5f8135905061094b81610927565b92915050565b5f819050919050565b61096381610951565b811461096d575f5ffd5b50565b5f8135905061097e8161095a565b92915050565b5f5f5f5f6080858703121561099c5761099b6108f3565b5b5f6109a98782880161093d565b94505060206109ba87828801610970565b93505060406109cb8782880161093d565b92505060606109dc87828801610970565b91505092959194509250565b5f819050919050565b6109fa816109e8565b82525050565b610a0981610951565b82525050565b5f606082019050610a225f8301866109f1565b610a2f6020830185610a00565b610a3c6040830184610a00565b949350505050565b5f5f60408385031215610a5a57610a596108f3565b5b5f610a678582860161093d565b9250506020610a7885828601610970565b9150509250929050565b5f602082019050610a955f830184610a00565b92915050565b5f5f5f5f60808587031215610ab357610ab26108f3565b5b5f610ac08782880161093d565b9450506020610ad18782880161093d565b9350506040610ae287828801610970565b9250506060610af387828801610970565b91505092959194509250565b610b0881610916565b82525050565b5f604082019050610b215f830185610aff565b610b2e6020830184610aff565b9392505050565b5f60ff82169050919050565b610b4a81610b35565b82525050565b5f60a082019050610b635f830188610a00565b610b706020830187610aff565b610b7d6040830186610aff565b610b8a6060830185610b41565b610b976080830184610a00565b9695505050505050565b610baa81610b35565b8114610bb4575f5ffd5b50565b5f81359050610bc581610ba1565b92915050565b5f5f5f5f5f5f60c08789031215610be557610be46108f3565b5b5f610bf289828a0161093d565b9650506020610c0389828a01610970565b9550506040610c1489828a0161093d565b9450506060610c2589828a0161093d565b9350506080610c3689828a01610bb7565b92505060a0610c4789828a01610970565b9150509295509295509295565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610c8b826109e8565b9150610c96836109e8565b925082820390508181125f8412168282135f851215161715610cbb57610cba610c54565b5b92915050565b5f81519050610ccf81610927565b92915050565b5f60208284031215610cea57610ce96108f3565b5b5f610cf784828501610cc1565b91505092915050565b5f8115159050919050565b610d1481610d00565b82525050565b5f604082019050610d2d5f830185610aff565b610d3a6020830184610d0b565b9392505050565b5f81519050610d4f8161095a565b92915050565b5f60208284031215610d6a57610d696108f3565b5b5f610d7784828501610d41565b91505092915050565b5f610d8a82610951565b9150610d9583610951565b9250828202610da381610951565b91508282048414831517610dba57610db9610c54565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610df882610951565b9150610e0383610951565b925082610e1357610e12610dc1565b5b828204905092915050565b5f606082019050610e315f830186610a00565b610e3e6020830185610aff565b610e4b6040830184610aff565b949350505050565b5f5f5f5f60808587031215610e6b57610e6a6108f3565b5b5f610e7887828801610d41565b9450506020610e8987828801610cc1565b9350506040610e9a87828801610cc1565b9250506060610eab87828801610cc1565b91505092959194509250565b5f81519050610ec581610ba1565b92915050565b5f60208284031215610ee057610edf6108f3565b5b5f610eed84828501610eb7565b91505092915050565b5f610f0082610b35565b9150610f0b83610b35565b9250828203905060ff811115610f2457610f23610c54565b5b92915050565b5f8160011c9050919050565b5f5f8291508390505b6001851115610f7f57808604811115610f5b57610f5a610c54565b5b6001851615610f6a5780820291505b8081029050610f7885610f2a565b9450610f3f565b94509492505050565b5f82610f975760019050611052565b81610fa4575f9050611052565b8160018114610fba5760028114610fc457610ff3565b6001915050611052565b60ff841115610fd657610fd5610c54565b5b8360020a915084821115610fed57610fec610c54565b5b50611052565b5060208310610133831016604e8410600b84101617156110285782820a90508381111561102357611022610c54565b5b611052565b6110358484846001610f36565b9250905081840481111561104c5761104b610c54565b5b81810290505b9392505050565b5f61106382610951565b915061106e83610b35565b925061109b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610f88565b90509291505056fea26469706673582212208eb847b6bc810320a0c86e9ef7826d0b93c5eaf9910841a911b1b45ea3a1401b64736f6c634300081e0033"
)

func GetBlockOverride(ctx context.Context, client *ethclient.Client, blockNumber uint64) (*query.BlockOverrides, error) {
	thisBlock, err := client.BlockByNumber(ctx, big.NewInt(int64(blockNumber)))
	if err != nil {
		return nil, fmt.Errorf("failed to get block: %v", err)
	}
	time := hexutil.Uint64(thisBlock.Time()) + 12
	number := hexutil.Big(*thisBlock.Number())
	gasLimit := hexutil.Uint64(thisBlock.GasLimit())
	feeRecipient := thisBlock.Coinbase()
	prevRandao := thisBlock.Header().MixDigest
	baseFeePerGas := hexutil.Big(*thisBlock.BaseFee())
	// beaconRoot := *thisBlock.BeaconRoot()
	blockOverrides := &query.BlockOverrides{
		Time:          &time,
		Number:        &number,
		GasLimit:      &gasLimit,
		FeeRecipient:  &feeRecipient,
		PrevRandao:    &prevRandao,
		BaseFeePerGas: &baseFeePerGas,
		// BeaconRoot:    &beaconRoot,
	}
	return blockOverrides, nil
}

func GetEulerRevenue(
	ctx context.Context, rpcUrl string, client *ethclient.Client,
	debt common.Address, debtAmount *big.Int,
	collateral common.Address, collateralAmount *big.Int,
	blockNumber *big.Int, txIndex uint,
) (*big.Int, *big.Int, *big.Int, error) {
	parsedABI, err := abi.JSON(strings.NewReader(eulerLensAbi))
	if err != nil {
		return nil, nil, nil, fmt.Errorf("failed to parse eulerLensAbi: %v", err)
	}
	dummyAddress := common.HexToAddress("0x0000000000000000000000000000000000000000")

	data, err := parsedABI.Pack("getRevenue", debt, debtAmount, collateral, collateralAmount)
	if err != nil {
		return nil, nil, nil, fmt.Errorf("failed to pack data: %v", err)
	}

	blockOverrides, err := GetBlockOverride(ctx, client, blockNumber.Uint64())
	if err != nil {
		return nil, nil, nil, fmt.Errorf("failed to get block overrides: %v", err)
	}

	params := []interface{}{
		map[string]interface{}{ // Tx Obj
			"to":   dummyAddress.Hex(),
			"data": "0x" + hex.EncodeToString(data),
		},
		"0x" + blockNumber.Text(16),
		map[string]interface{}{ // TraceConfig
			"tracer": "callTracer",
			"tracerConfig": map[string]interface{}{
				"withLog": true,
			},
			"stateOverrides": map[string]interface{}{
				dummyAddress.Hex(): map[string]interface{}{
					"code": eulerLensDeployedBytecode,
				},
			},
			"blockOverrides": blockOverrides,
			"txIndex":        fmt.Sprintf("0x%x", txIndex),
		},
	}

	// Geth style debug_traceCall
	payload := query.RPCRequest{
		JSONRPC: "2.0",
		Method:  "debug_traceCall",
		Params:  params,
		ID:      1,
	}

	jsonData, err := json.Marshal(payload)
	if err != nil {
		return nil, nil, nil, fmt.Errorf("failed to marshal json: %v", err)
	}

	resp, err := http.Post(rpcUrl, "application/json", bytes.NewBuffer(jsonData))
	if err != nil {
		return nil, nil, nil, fmt.Errorf("failed to post: %v", err)
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)

	var rpcResp query.RPCResponse
	if err := json.Unmarshal(body, &rpcResp); err != nil {
		return nil, nil, nil, fmt.Errorf("failed to unmarshal: %v", err)
	}

	if rpcResp.Error != nil {
		fmt.Println("RPC Error:", rpcResp.Error.Message)
		return nil, nil, nil, err
	}

	var traceResult trace.CallTrace
	if err := json.Unmarshal(rpcResp.Result, &traceResult); err != nil {
		return nil, nil, nil, fmt.Errorf("failed to unmarshal: %v", err)
	}

	if len(traceResult.Output) != 96 {
		fmt.Println(traceResult.Error)
		marshaled, err := json.MarshalIndent(traceResult, "", "  ")
		if err != nil {
			return nil, nil, nil, fmt.Errorf("failed to marshal traceResult: %v", err)
		}
		fmt.Println(string(marshaled))

		return nil, nil, nil, fmt.Errorf("output length is not 96: %v", traceResult.Output)
	}

	revenue := utils.ParseInt256(traceResult.Output[0:32])
	debtValue := new(big.Int).SetBytes(traceResult.Output[32:64])
	collateralValue := new(big.Int).SetBytes(traceResult.Output[64:96])
	// fmt.Println("Revenue:", revenue)
	// fmt.Println("Debt Value:", debtValue)
	// fmt.Println("Collateral Value:", collateralValue)

	return revenue, debtValue, collateralValue, nil
}
